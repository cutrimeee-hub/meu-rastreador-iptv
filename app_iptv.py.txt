import streamlit as st
import asyncio
import aiohttp
import re
import pandas as pd

# Configura√ß√µes de Estilo
st.set_page_config(page_title="IPTV Master Hunter", layout="wide")
st.title("üöÄ IPTV Automator Pro")
st.subheader("Varredura, Valida√ß√£o e Link √önico")

# Lista de fontes (Voc√™ pode adicionar mais aqui)
FONTES = [
    "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/br.m3u",
    "https://iptv-org.github.io/iptv/languages/por.m3u"
]

async def validar_canal(session, nome, url):
    try:
        async with session.get(url, timeout=3) as resp:
            if resp.status == 200:
                return {"Canal": nome, "Status": "‚úÖ Online", "URL": url}
    except:
        pass
    return None

async def iniciar_processo():
    resultados = []
    progresso = st.progress(0)
    status_text = st.empty()
    
    async with aiohttp.ClientSession() as session:
        for idx, fonte in enumerate(FONTES):
            status_text.text(f"Lendo fonte: {fonte}...")
            async with session.get(fonte) as r:
                texto = await r.text()
                matches = re.findall(r'#EXTINF:.*?,(.*?)\n(http.*?)\n', texto)
                
                tasks = [validar_canal(session, m[0], m[1]) for m in matches[:50]] # Limitado a 50 para teste r√°pido
                res = await asyncio.gather(*tasks)
                resultados.extend([r for r in res if r])
            progresso.progress((idx + 1) / len(FONTES))
            
    return resultados

# Interface do Usu√°rio
col1, col2 = st.columns([1, 3])

with col1:
    if st.button("üîç Iniciar Varredura"):
        with st.spinner("Validando canais..."):
            lista_final = asyncio.run(iniciar_processo())
            st.session_state['lista'] = lista_final
            st.success(f"{len(lista_final)} canais encontrados!")

if 'lista' in st.session_state:
    df = pd.DataFrame(st.session_state['lista'])
    
    with col2:
        st.write("### Canais Ativos")
        st.dataframe(df, use_container_width=True)
        
        # Gerar M3U para Download
        m3u_content = "#EXTM3U\n"
        for item in st.session_state['lista']:
            m3u_content += f"#EXTINF:-1,{item['Canal']}\n{item['URL']}\n"
            
        st.download_button("üì• Baixar Lista Atualizada (.m3u)", m3u_content, "minha_lista.m3u")